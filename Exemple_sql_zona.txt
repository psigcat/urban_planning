# *******************************************************************************
# Plugin FitxaUrban 2.0
#
# Plantilla base del query per les fitxes de zones
# *******************************************************************************

SELECT qua.codi AS qua_codi, qua.descripcio AS qua_descripcio, ST_Area(ST_Multi(ST_Intersection(parcela.geom, qua.geom))) AS area_int,
       (ST_Area(ST_Multi(ST_Intersection(parcela.geom, qua.geom))) / parcela.area)*100 as per_int, qg.tipus_qualif AS qg_tipus, qg.  subzona AS qg_subzona,
       qg.definicio AS qg_definicio, tord.cod_ord AS tord_codi, tord.tipus_ord AS tord_descripcio, hab_unifamiliar, hab_plurifamiliar, hab_rural, res_especial,
       res_mobil, hoteler, com_petit, com_mitja, com_gran,
       oficines_serveis, restauracio, recreatiu, magatzem, industrial_1, industrial_2, industrial_3, industrial_4, industrial_5,
       taller_reparacio, educatiu, sanitari, assistencial, cultural, associatiu, esportiu, serveis_publics, serveis_tecnics,
       serveis_ambientals, serveis_radio, aparcament, estacions_servei, agricola, ramader, forestal, lleure, ecologic,
       fondaria_edif, edificabilitat, ocupacio, densitat_hab, vol_max_edif, fondaria_edif_pb, pb, alcada, punt_aplic, sep_min, 
       constr_aux_alcada, constr_auxo_cupacio, tanques, nplantes, alcada_lliure, entresol_pb, sotacoberta, pendent,
       terrasses, elem_sort, cossos_sort, cossos_annexes, porxos, tract_facana, comp_facana, prop_obertura, material_facana,
       material_coberta, fusteria, espai_lliure, altell, altres, front_min, parce_min, prof_min
  FROM carto.parcela AS parcela, carto.qualificacions AS qua
       INNER JOIN data.qualificacio_general AS qg ON qua.codi = qg.id
       LEFT JOIN data.tipus_ordenacio AS tord ON qg.cod_ord = tord.cod_ord
       LEFT JOIN data.usos ON qg.id = usos.id
       LEFT JOIN data.condicions_edif ON qg.id = condicions_edif.id
       LEFT JOIN data.condicions_parce ON qg.id = data.condicions_parce.id
  WHERE parcela.ninterno = $ID_VALUE
        AND ST_Intersects(parcela.geom, qua.geom)
  ORDER BY area_int DESC
  LIMIT 4
